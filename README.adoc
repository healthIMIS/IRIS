:toc: macro

# image:logo/iris-logo.png[width=100] IRIS System

IRIS stands for "Integration of Remote systems into Infection control Software" and is intended to be the central point of mediation between the various contact, event and guest tracking apps on the one hand and the infection control software (e.g. SORMAS) in the health departments on the other.

This repository is used to manage the development and source code of IRIS.

NOTE: The IRIS system is work in progress. If you are interested or have questions please reach out to us.

toc::[]

////
== Concept

There is a concept written in German which describes the IRIS system: https://github.com/healthIMIS/IRIS-Concept/releases/latest[Last release of the concept]
////

== IRIS System

There are two services in the IRIS system:

- One server (`public-server`) for the public Internet, which provides a REST API for the citizen apps and receives the apps' data.
- A service on the health department's side (`client-sormas-sidecar`), which feeds the data into the department's Sormas and generally takes care of the communication with Sormas.
- _A second server (`hd-server`) is for a secure government network, which fetches the data from the public server and makes it available to the health departments. This is not being used at the moment, as it is still unclear whether it will be needed!_

The services are Spring Boot based applications exposing RESTful APIs and running without a user interface.

These are standard Maven projects and just be imported in any IDE. For convenience, enable the <<localDev,`localDev` Maven profile>> so that running the services from your IDE does not need to access a database, but uses H2 in-memory. <<lombok,Note the use of lombok!>>

Further components are:

- A simple CLI application for tests and demonstration (`dummy-app`).
- A very simple web application (`dummy-web`) - this should be outdated.
- The client library for SORMAS' REST-API (`sormas-api-client`).

=== Quickstart

To work with SORMAS you should clone it from https://github.com/hzi-braunschweig/SORMAS-Project and look at https://github.com/hzi-braunschweig/SORMAS-Project/blob/development/sormas-cargoserver/README.md

Run the services.

[source, bash]
----
$ git clone git@github.com:healthIMIS/IRIS.git iris <1>

$ cd iris/iris-public-server <2>
$ ./mvnw spring-boot:run -PlocalDev <3>

# in a secound console
$ cd iris/iris-sormas-api-client <4>
$ ./mvnw install <5>

$ cd iris/iris-client-sormas-sidecar <6>
$ ./mvnw spring-boot:run -PlocalDev <7>
----
<1> Clone the repository.
<2> Switch to the public server.
<3> Run the server with an in-memory database.
    * Public server uses port *8090* by default
<4> Switch to the SORMAS REST client.
<5> Build this library and put it into the maven repository. This does not have to be done over and over again, but only initially once and for the rare changes to the library.
<6> Switch to the health department client.
<7> Run the service with an in-memory database.

////
// are currently not generated
[[sample_data]]
==== Sample data

If the servers are started with the <<profiles,Spring profile>> `psql_compose_db` or `h2_db`, then the following sample data is inserted into the database at each startup. The H2 db is in-memory and therefore not persistent. The Postgres db is cleaned with the profile `psql_compose_db` at startup before the data is imported.

===== Data requests

[width="100%",options="header"]
|====================
| Request-ID / Code | Department-ID | Check code - Name | Check code - Day of Birth | Check code - Random | From | To | Feature
//-------------------
| 790b9a69-17f8-4ba7-a8ae-2f7bf34e0b80 | a04d2e43-3d1a-464e-9926-e190ccf2dd03 | e7fcc353b0b13024d48f74a718d8d721 ⇒ MD5 of maxmuster | c82c1cd77fbd144003b1e476718f66ce ⇒ MD5 of 19900101 | ABCDEFGHIJ | now - 2 Days | | Contact
| 2707fd28-9b4f-4140-b80e-d56d9aad831f | a04d2e43-3d1a-464e-9926-e190ccf2dd03 | cd0087e4707045b33c144bf09305c2a5 ⇒ MD5 of thomasmüller | | 9876543XYZ | now - 4 Days  | now - 2 Days | Contact + Events
| 3907e730-af89-4944-8e75-fbe6ba60c904 | 6afbbe9b-938c-46d7-93e4-7c9e1f737273 | bce7a55a7b8a8a89c33c4879fc545cc9 ⇒ MD5 of heikebaum | | 23456789AB | now - 4 Days  | now - 2 Days | Contact
|====================

===== Data submissions

[width="100%",options="header"]
|====================
| Request-ID / Code | Department-ID | Salt | Key Referenz | Encrypte Data | Feature
//-------------------
| 790b9a69-17f8-4ba7-a8ae-2f7bf34e0b80 | a04d2e43-3d1a-464e-9926-e190ccf2dd03 | salt | key | DATA OF CONTACTS | Contact
| 790b9a69-17f8-4ba7-a8ae-2f7bf34e0b80 | a04d2e43-3d1a-464e-9926-e190ccf2dd03 | salt | key | DATA OF EVENTS | Events
|====================
////

==== Dummy App

There is a small Java CLI application as dummy citizen app in the folder `iris-dummy-app` for test and demonstration suppose. This app uses the public API of IRIS, read data requests for a code and put data submissions. For use, the public server must be running!

[source, bash]
----
$ cd iris/iris-dummy-app <1>
$ ./mvnw package <2>
$ java -jar target/iris-dummy-app-0.0.1-SNAPSHOT-jar-with-dependencies.jar <3>
----
<1> Switch to the dummy app project.
<2> Build the app as Jar with all dependencies.
<3> Run the application in a command line. With the parameter `-h` you get a help output.

=== Maven profiles

[width="100%",cols="1a,9a"]
|====================
| [[localDev]] localDev | Includes H2 database driver as dependency and activates the `dev` Spring profile group and the `local` Spring profile.

NOTE: This profile is activated automaticly if there a file application-local.properties under src/main/resources.
|====================

[[profiles]]
=== Spring profiles

Activate the needed profile(s) by setting the `spring.profiles.active` property respective parameter or the `SPRING_PROFILES_ACTIVE` environment variable.

==== Profile groups

[width="100%",cols="1a,9a"]
|====================
| dev | h2_db, dev_env, local
| dev_psql | psql_compose_db, dev_env
| prod | prod_db
|====================

==== Profiles

[width="100%",cols="1a,9a"]
|====================
| local | Exclusively local profile which is not checked into the Git repository. Can be used to set special settings (e.g. work against a locally installed database). If the profile file `application-local.properties` exist, the <<localDev,Maven profile `localDev`>> is activated for easy local execution.
| h2_db | H2 in-memory database and H2 Console
    
NOTE: The <<sample_data,sample data>> are inserted at server startup.

| psql_compose_db | Configuration for the Postgres database at localhost started with the Docker-Compose: `iris/infrastructure/docker-compose.yml`
    
NOTE: The database is cleaned and the <<sample_data,sample data>> are inserted at server startup.

| prod_db | Configuration for the production database, where most settings are likely to be made via the respective environment.

| dev_env | Some additional configurations for execution during development (e.g. debug logging).

| docker | Configuration for the Docker image with Postgres database at host postgres. This is intended for use with Docker-Compose: `iris/infrastructure/docker-compose_with-servers.yml`
|====================

[[postgres]]
=== PostgreSQL Database

There is a Docker-Compose configuration (`infrastructure/docker-compose.yml`) which provides a Postgres db and a pgAdmin via Docker. 

DB:: 
    - login = postgres:postgres; 
    - hostname in Docker = postgres
    - port on host = 5433
    - databases = iris_public + iris_hd + iris_client
    - Docker volume = psqldata_iris

pgAdmin::
    - login = postgres@healthIMIS.de:postgres
    - port on host = 5555
    
=== Run with Docker

You can build Docker images for the services and run this with Docker.

[source, bash]
----
$ # preparation
$ cd iris/infrastructure <1>
$ cp iris-sormas.env.example iris-sormas.env <2>
$ nano iris-sormas.env <2>

$ cd .. <3>
$ ./mvnw package spring-boot:build-image -DskipTests <4>
$ docker-compose -f infrastructure/docker-compose-servers.yml up -d <5>
----
<1> Switch to the infrastructure directory of the iris workspace.
<2> Copy the example of the iris-sormas.env and edit this. Insert the username and password of the IRIS user in your SORMAS test instance.
<3> Switch back to the root directory of the IRIS workspace.
<4> Build the libraries and the images of all services.
<5> Run the Postgres db, the pgAdmin, the public server and the client service with Docker-Compose.
    * Postgres DB <<postgres,as above>>
    * Public server uses port *8443* by default

=== Libraries

The services are based on the following open source projects:

- Spring Boot 2.4
- Spring MVC
- Spring Data
- https://flywaydb.org[Flyway] – for database migration
- https://projectlombok.org[Project Lombok] – for low level code generation
- https://www.vavr.io/[Vavr] – for a better more functional programming style

[[lombok]]
IMPORTANT: Make sure you have the Lombok plugin installed in your IDE so that your code can compile correctly.

== Encryption of the data to be transmitted (contact data)

In order to be not limited in the amount of data, a hybrid encryption with symmetric encryption of the data and asymmetric encryption of the symmetric key is used for the encryption of the contact data.

1. The apps and applications get the public key of the health department as a 4096-bit RSA key from the IRIS+ server. This key is base64-encoded in the Private Enhanced Mail (PEM) format.
2. The app generates a 256-bit AES key.
3. With this key the data is encrypted (algorithm: AES).
4. The AES key must be encrypted with the public RSA key of the health department. (algorithm: RSA with Optimal Asymmetric Encryption Padding (OAEP))
5. The encrypted AES key and the encrypted content must be transmitted base64 encoded.

=== Schematic sequence

```
pubKeyEncryption = publicKeyFromPem(givenPublicKey);
contentKey = generateAESKey();

encrypted = contentKey.encrypt(content);
keyEncrypted = pubKeyEncryption.encrypt(contentKey, "RSA/NONE/OAEPWithSHA3-256AndMGF1Padding");

dataToTransport = base64Encode(encrypted);
keyToTransport = base64Encode(keyEncrypted);
```

== Development 
=== Java parts

We use *Java 11* and the following code style. 

==== Eclipse
https://github.com/iris-gateway/IRIS/tree/main/infrastructure/eclipse-code-formatter.xml[infrastructure/eclipse-code-formatter.xml] +
https://github.com/iris-gateway/IRIS/tree/main/infrastructure/eclipse.importorder[infrastructure/eclipse.importorder]

==== Import order

* static imports, wild card used from the first declaration
* `+*+` - all unmatched imports
* `java.…`
* `javax.–`
* `org.…`
* `com.…`

For non-static imports we switch to `+*+` imports after the 10th import.
For static ones we always use `+*+` ones.

==== Blank lines

Use blank lines to group pieces of code logically: variable initializations go together, followed by the method invocations that use those variables.
There's no hard rule here.
It's just nice to be able to identify different steps in the execution order.

For blocks (if clauses, methods) we start with a blank line if the subsequent code is longer than a single line:

[source, java]
----
void someLongMethod() {

  // First statement
  // Second statement
}

VS.

void someOneLineMethod() {
  // Single-line statement
}
----

Symmetric blocks usually also use a blank line on the end to clearly separate the blocks' content from the outer instruction.
Again, the single line rule applies, here, too.

[source, java]
----
if (…) {
  // Single line instruction
} else {
  // Single line instruction
}

but

if (…) {

  // Multi-line instruction
  // Multi-line instruction

} else {

  // Multi-line instruction
  // Multi-line instruction
}
----

The intermediate lines surrounding the `…} else {…` make it easier to see where the block flips.

In general, for if-else-clauses, prefer the ternary expression (`condition ? if-true : if-false`) over an if block.
That creates incentives to rather extract the statements to be executed in either and make the overall expression readable.
If the overall expression gets so long it would line break, it's nice to read if the three parts are each brought onto a single line:

[source, java]
----
Object someMethod(…) {

  return condition
    ? if-true-do-this
    : else-do-that;
}
----
