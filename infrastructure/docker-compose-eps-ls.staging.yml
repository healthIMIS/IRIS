########################################################
# Intended for the all in one staging environment on the VM 
# 
# provides a NGINX server with certificates and configuration for staging.iris-gateway.de
# togehter with the IRIS applications and with a Postgresql database and SORMAS
# DB: look at docker-compose-postgres.yml
# SORMAS: port = /; look at docker-compose-sormas.base.yml
# IRIS public: port = /
# IRIS location: port = /
# IRIS client: port = /; look at docker-compose-hd-client.base.yml
# IRIS frontend: port = /; look at docker-compose-hd-client.base.yml
# NGINX: port = 443
########################################################
version: '3'
services:

  iris-location:
    image: inoeg/iris-location-service:v1.0.0-alpha
    restart: unless-stopped
    depends_on:
      - ls-1
    expose:
      - 8080

  ls-1:
    image: luckylusa/iris-eps-server:v2
    expose:
      - 4445
    ports:
      - 4445:4445
    volumes:
      - "/home/iris/iris-eps/iris-gateway/infrastructure/eps/settings:/app/settings"
    environment:
      - EPS_SETTINGS=settings/dev/roles/ls-1
    command: [ "--level", "debug", "server", "run" ]

  iris-app-api-demo:
    image: inoeg/demo-checkin-app:v1.0.0-alpha
    environment:
      - EPS_CLIENT_CLIENT_URL=https://iris-app-api-demo-eps:5554/jsonrpc
    depends_on:
      iris-location:
        condition: service_started
    ports:
      - 8091:8091
    restart: unless-stopped

  iris-app-api-demo-eps:
    image: luckylusa/iris-eps-server:v2
    depends_on:
      iris-app-api-demo:
        condition: service_started
    expose:
      - 4444
    ports:
      - 4444:4444
    volumes:
      - "/home/iris/iris-eps/iris-gateway/infrastructure/eps/settings:/app/settings"
    environment:
      - EPS_SETTINGS=settings/dev/roles/demo-app
    command: [ "--level", "trace", "server", "run" ]

  public-proxy:
    image: luckylusa/eps-proxy:latest
    expose:
      - 4433
      - 9999
    ports:
      - 4433:4433
    volumes:
      - "/home/iris/iris-eps/iris-gateway/infrastructure/eps/settings:/app/settings"
    environment:
      - EPS_SETTINGS=settings/dev/roles/public-proxy-1
    command: [ "proxy", "run", "public" ]

  public-proxy-eps:
    image: luckylusa/iris-eps-server:v2
    expose:
      - 5556
      - 5544
    ports:
      - 5556:5556
    volumes:
      - "/home/iris/iris-eps/iris-gateway/infrastructure/eps/settings:/app/settings"
    environment:
      - EPS_SETTINGS=settings/dev/roles/public-proxy-eps-1
    command: [ "--level", "trace", "server", "run" ]

  internal-server:
    image: luckylusa/eps-internal-server:latest
    volumes:
      - "/home/iris/iris-eps/iris-gateway/infrastructure/eps/settings:/app/settings"
    expose:
      - 8888
    command: [ "--level", "trace" ]


